<UserControl x:Class="VorTech.App.Views.DevisView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             d:DesignWidth="1400" d:DesignHeight="860">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- Toolbar -->
            <RowDefinition Height="*"/>
            <!-- Content -->
            <RowDefinition Height="Auto"/>
            <!-- Footer -->
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <DockPanel Grid.Row="0" Margin="8" LastChildFill="False">
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                <TextBlock Text="Devis" FontSize="20" FontWeight="Bold" VerticalAlignment="Center"/>
                <TextBlock Text=" " Width="8"/>
                <TextBlock Text="{Binding Numero}" FontSize="16" Opacity="0.8" VerticalAlignment="Center"/>
                <TextBlock Text=" • " Margin="8,0" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding Etat}" VerticalAlignment="Center"/>
                <TextBlock Text=" • " Margin="8,0" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding Date, StringFormat={}{0:yyyy-MM-dd}}" VerticalAlignment="Center"/>
            </StackPanel>

            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right">
                <Button Content="Enregistrer" Click="Save_Click" />
                <Button Content="Générer PDF" Padding="12,6" Margin="4,0"/>
                <Button Content="Émettre (numéro)" Padding="12,6" Margin="4,0" Click="Emit_Click"/>
            </StackPanel>
        </DockPanel>

        <!-- Corps en 3 colonnes : Liste devis | Fiche | Annexes -->
        <Grid Grid.Row="1" Margin="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="320"/>
                <!-- Liste devis -->
                <ColumnDefinition Width="*"/>
                <!-- Fiche devis -->
                <ColumnDefinition Width="420"/>
                <!-- Annexes + compte bancaire -->
            </Grid.ColumnDefinitions>

            <!-- Colonne gauche : Liste des devis + recherche -->
            <DockPanel Grid.Column="0" Margin="0,0,12,0">
                <StackPanel DockPanel.Dock="Top" Margin="0,0,0,8">
                    <TextBlock Text="Recherche" FontWeight="Bold" Margin="0,0,0,4"/>
                    <TextBox x:Name="SearchBox" Width="220"
                           ToolTip="Numéro de devis, nom/prénom/société"
                           TextChanged="OnSearchTextChanged"/>
                </StackPanel>

                <!-- LISTE DES DEVIS -->
                <GroupBox Header="Devis" DockPanel.Dock="Bottom">
                    <ListBox x:Name="DevisList" MinHeight="500"
                             SelectionChanged="OnListSelectionChanged"
                             Background="#FF2B2B2B" BorderBrush="#FF404040" Foreground="#FFEFEFEF"
                             ScrollViewer.VerticalScrollBarVisibility="Auto">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <DockPanel Margin="4">
                                    <TextBlock Text="{Binding Etat}" Foreground="Gray" DockPanel.Dock="Right" Margin="8,0,0,0" VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding Numero}" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                </DockPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </GroupBox>
            </DockPanel>

            <!-- Colonne centrale : Fiche devis -->
            <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="0,0,12,0">
                    <!-- Destinataire -->
                    <GroupBox Header="Destinataire" Margin="0,0,0,12">
                        <!-- IMPORTANT : un seul enfant direct du GroupBox -->
                        <Grid Margin="8">
                            <!-- Ces deux blocs DOIVENT être directement sous <Grid> -->
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="150"/>
                                <!-- labels -->
                                <ColumnDefinition Width="*"/>
                                <!-- champs -->
                                <ColumnDefinition Width="130"/>
                                <!-- labels -->
                                <ColumnDefinition Width="*"/>
                                <!-- champs -->
                            </Grid.ColumnDefinitions>

                            <!-- Ligne 0 : Sélection client -->
                            <Label Grid.Row="0" Grid.Column="0" Content="Client" VerticalAlignment="Center"/>
                            <Grid Grid.Row="0" Grid.Column="1" Grid.ColumnSpan="3">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox Grid.Column="0" x:Name="TxtClientQuick"
                                       ToolTip="Recherche libre (facultatif)"
                                       Margin="0,0,8,0"/>
                                <!-- NE PAS mettre de contenu entre <Button>...</Button> si Content=... est déjà utilisé -->
                                <Button Grid.Column="1" Content="Sélectionner…" Padding="10,6"
                                        Click="SelectClient_Click"/>
                            </Grid>

                            <!-- Ligne 1 : Société / Nom Prénom -->
                            <Label Grid.Row="1" Grid.Column="0" Content="Société" VerticalAlignment="Center"/>
                            <TextBox Grid.Row="1" Grid.Column="1" Margin="0,4,8,4"
                                     Text="{Binding ClientSociete, UpdateSourceTrigger=LostFocus}"
                                     LostFocus="ClientFields_LostFocus"/>
                            <Label Grid.Row="1" Grid.Column="2" Content="Nom Prénom" VerticalAlignment="Center"/>
                            <TextBox Grid.Row="1" Grid.Column="3" Margin="0,4,0,4"
                                     Text="{Binding ClientNomPrenom, UpdateSourceTrigger=LostFocus}"
                                     LostFocus="ClientFields_LostFocus"/>

                            <!-- Ligne 2 : Adresse -->
                            <Label Grid.Row="2" Grid.Column="0" Content="Adresse" VerticalAlignment="Center"/>
                            <TextBox Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="3" Margin="0,4,0,4"
                                     Text="{Binding ClientAdresseL1, UpdateSourceTrigger=LostFocus}"
                                     LostFocus="ClientFields_LostFocus"/>

                            <!-- Ligne 3 : CP / Ville -->
                            <Label Grid.Row="3" Grid.Column="0" Content="Code postal" VerticalAlignment="Center"/>
                            <TextBox Grid.Row="3" Grid.Column="1" Margin="0,4,8,0" Width="120"
                                     Text="{Binding ClientCodePostal, UpdateSourceTrigger=LostFocus}"
                                     LostFocus="ClientFields_LostFocus"/>
                            <Label Grid.Row="3" Grid.Column="2" Content="Ville" VerticalAlignment="Center"/>
                            <TextBox Grid.Row="3" Grid.Column="3" Margin="0,4,0,0"
                                     Text="{Binding ClientVille, UpdateSourceTrigger=LostFocus}"
                                     LostFocus="ClientFields_LostFocus"/>

                            <!-- Ligne 4 : Email / Téléphone -->
                            <Label Grid.Row="4" Grid.Column="0" Content="Email" VerticalAlignment="Center"/>
                            <TextBox Grid.Row="4" Grid.Column="1" Margin="0,4,8,0"
                                     Text="{Binding ClientEmail, UpdateSourceTrigger=LostFocus}"
                                     LostFocus="ClientFields_LostFocus"/>
                            <Label Grid.Row="4" Grid.Column="2" Content="Téléphone" VerticalAlignment="Center"/>
                            <TextBox Grid.Row="4" Grid.Column="3" Margin="0,4,0,0"
                                     Text="{Binding ClientTelephone, UpdateSourceTrigger=LostFocus}"
                                     LostFocus="ClientFields_LostFocus"/>
                        </Grid>
                    </GroupBox>

                    <!-- Lignes -->
                    <GroupBox Header="Lignes" Margin="0,0,0,12">
                        <DockPanel Margin="8">
                            <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Margin="0,0,0,8">
                                <Button Content="+ Ajouter"  Margin="0,0,8,0" Click="AddLine_Click"/>
                                <Button Content="Dupliquer"  Margin="0,0,8,0" Click="DuplicateLine_Click"/>
                                <Button Content="Supprimer"  Click="DeleteLine_Click"/>
                            </StackPanel>

                            <DataGrid x:Name="GridLines"
                                      ItemsSource="{Binding Lignes}" AutoGenerateColumns="False" 
                                      CanUserAddRows="False"
                                      CellEditEnding="CellEditEnded">
                                <DataGrid.RowStyle>
                                    <Style TargetType="DataGridRow">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsStockOk}" Value="False">
                                                <Setter Property="Foreground" Value="Red"/>
                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </DataGrid.RowStyle>
                                <DataGrid.Columns>
                                    <!-- Image -->
                                    <DataGridTemplateColumn Header=" " Width="48">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Image Source="{Binding ImagePath}" Stretch="UniformToFill" Width="40" Height="40"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <DataGridTextColumn Header="Désignation" Binding="{Binding Designation, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                                    <DataGridTextColumn Header="Qté" Binding="{Binding Qty, StringFormat={}{0:#0.##}, UpdateSourceTrigger=PropertyChanged}" Width="80"/>
                                    <DataGridTextColumn Header="PU (€)" Binding="{Binding PU, StringFormat={}{0:0.##}, UpdateSourceTrigger=PropertyChanged}" Width="100"/>
                                    <DataGridTextColumn Header="Montant (€)" IsReadOnly="True"
                                                        Binding="{Binding Montant, StringFormat={}{0:0.##}}" Width="120"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </DockPanel>
                    </GroupBox>

                    <!-- Remise + Total -->
                    <Grid Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Remise globale (€)" VerticalAlignment="Center"/>
                            <TextBlock Text=" " Width="8"/>

                            <!-- ✅ Binding en markup étendu pour éviter les erreurs de parsing -->
                            <TextBox Width="120" LostFocus="RemiseLostFocus">
                                <TextBox.Text>
                                    <Binding Path="RemiseGlobale" UpdateSourceTrigger="LostFocus" StringFormat="{}{0:0.##}"/>
                                </TextBox.Text>
                            </TextBox>
                        </StackPanel>

                        <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                            <TextBlock Text="Total :" FontSize="18" FontWeight="Bold" VerticalAlignment="Center"/>
                            <TextBlock Text=" " Width="8"/>
                            <TextBlock>
                                <TextBlock.Text>
                                    <Binding Path="Total" StringFormat="{}{0:0.##} €"/>
                                </TextBlock.Text>
                            </TextBlock>
                        </StackPanel>
                    </Grid>
                    <Grid Margin="0,12,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Orientation="Vertical">
                            <TextBlock x:Name="TxtCostMatiere" Text="Coût matières : 0 €" />
                            <TextBlock x:Name="TxtCharges"     Text="Charges estimées : 0 €" />
                            <TextBlock x:Name="TxtMarge"       Text="Marge brute : 0 €" FontWeight="Bold"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </ScrollViewer>

            <!-- Colonne droite : Annexes + compte bancaire -->
            <StackPanel Grid.Column="2">
                <GroupBox Header="Textes du devis" Margin="0,0,0,12"
                            Background="#FF2B2B2B" BorderBrush="#FF404040" Foreground="#FFEFEFEF">
                    <StackPanel Margin="8" Orientation="Horizontal" HorizontalAlignment="Center">
                        <Button Content="Éditer le texte (haut)" Click="EditNoteHaut_Click" Padding="10,6" Margin="0,0,8,0"/>
                        <Button Content="Éditer le texte (bas)"  Click="EditNoteBas_Click"  Padding="10,6"/>
                    </StackPanel>
                </GroupBox>
                <GroupBox Header="Annexes disponibles" Margin="0,0,0,12"
                        Background="#FFF7F7F7" BorderBrush="#FFDDDDDD" BorderThickness="1">
                    <StackPanel Margin="8">
                        <CheckBox Content="Planche produits (images + titres)"/>
                        <Separator Margin="0,8,0,8"/>
                        <TextBlock Text="Sélection des annexes :" FontWeight="Bold"/>
                        <ListBox x:Name="ListAnnexes" Height="220" ItemsSource="{Binding Annexes}"
                                 Background="#FF2B2B2B" BorderBrush="#FF404040" Foreground="#FFEFEFEF"
                                 ScrollViewer.VerticalScrollBarVisibility="Auto">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <DockPanel>
                                        <TextBlock Text="{Binding Chemin}" VerticalAlignment="Center"/>
                                        <StackPanel Orientation="Horizontal" DockPanel.Dock="Right">
                                            <Button Content="↑" Width="28" Margin="4,0"/>
                                            <Button Content="↓" Width="28" Margin="4,0"/>
                                            <Button Content="Retirer" Margin="4,0"/>
                                        </StackPanel>
                                    </DockPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                        <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                            <Button Content="+ Ajouter PDF"/>
                        </StackPanel>
                    </StackPanel>
                </GroupBox>

                <GroupBox Header="Compte bancaire (pied de page)" Background="#FFF7F7F7" BorderBrush="#FFDDDDDD" BorderThickness="1">
                    <StackPanel Margin="8">
                        <TextBlock Text="Choisir le compte à afficher en pied de page (IBAN/BIC)"/>
                        <ComboBox ItemsSource="{Binding ComptesBancaires}" DisplayMemberPath="Libelle" SelectedItem="{Binding CompteBancaireSelectionne}" Margin="0,6,0,0"/>
                    </StackPanel>
                </GroupBox>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
